name: Build AmiQuake

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: amigadev/crosstools:m68k-amigaos

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build AmiQuake
      run: |
        # Find NDK include path in container
        export NDK_INC=$(find /opt -path "*/ndk-include" -o -path "*/ndk/include" 2>/dev/null | head -1)
        if [ -z "$NDK_INC" ]; then
          # Try alternate locations
          if [ -d "/opt/m68k-amigaos/m68k-amigaos/ndk-include" ]; then
            export NDK_INC=/opt/m68k-amigaos/m68k-amigaos/ndk-include
          elif [ -d "/opt/m68k-amigaos/ndk-include" ]; then
            export NDK_INC=/opt/m68k-amigaos/ndk-include
          else
            export NDK_INC=/opt/amiga/m68k-amigaos/ndk-include
          fi
        fi
        echo "Using NDK_INC=$NDK_INC"
        ls -la "$NDK_INC" || true
        # Check for exec/funcdef.i
        find "$NDK_INC" -name "funcdef.i" || true
        make clean
        make NDK_INC=$NDK_INC

    - name: Check binary size
      run: |
        ls -lh build/AmiQuakeGCC build/AmiQuakeGCC-NoFPU
        size build/AmiQuakeGCC || true
        size build/AmiQuakeGCC-NoFPU || true

    - name: Package binaries
      run: |
        cd build
        cp ../README.md .
        zip AmiQuake-m68k.zip AmiQuakeGCC AmiQuakeGCC-NoFPU README.md
        ls -lh AmiQuake-m68k.zip
        cd ..

    - name: Upload binary artifacts
      uses: actions/upload-artifact@v4
      with:
        name: AmiQuake-m68k-${{ github.sha }}
        path: build/AmiQuake-m68k.zip
        retention-days: 90

    - name: Create release on tag
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: build/AmiQuake-m68k.zip
        body: |
          AmiQuake GCC m68k-amigaos dual-target build

          **AmiQuakeGCC** - FPU version
          - Target: Amiga 68040/68060 with FPU
          - NovaCoder's optimized C2P routine

          **AmiQuakeGCC-NoFPU** - Soft-float version
          - Target: Amiga 68020+ without FPU
          - Built with GCC m68k-amigaos toolchain
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
